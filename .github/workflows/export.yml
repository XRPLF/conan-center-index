name: Export

on:
  push:
    paths:
      - 'export.yml'
      - 'recipes/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  # Note that `conan user` implicitly uses the environment variables
  # `CONAN_LOGIN_USERNAME_<REMOTE>` and `CONAN_PASSWORD_<REMOTE>`, see also
  # https://docs.conan.io/2/reference/environment.html#remote-login-variables.
  CONAN_REMOTE_URL: https://conan.ripplex.io
  CONAN_REMOTE_NAME: xrplf
  CONAN_LOGIN_USERNAME_XRPLF: ${{ secrets.CONAN_USERNAME }}
  CONAN_PASSWORD_XRPLF: ${{ secrets.CONAN_PASSWORD }}
  CONAN_EXPORTS: >-
    protobuf/all
    snappy/all
    soci/all

jobs:
  build:
    runs-on: ubuntu-latest
    container: ghcr.io/xrplf/ci/debian-bookworm:gcc-12
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Add Conan remote
        run: |
          conan remote list
          if conan remote list | grep -q '${{ env.CONAN_REMOTE_NAME }}'; then
              conan remote remove ${{ env.CONAN_REMOTE_NAME }}
              echo "Removed existing conan remote '${{ env.CONAN_REMOTE_NAME }}'."
          fi
          conan remote add --index 0 ${{ env.CONAN_REMOTE_NAME }} ${{ env.CONAN_REMOTE_URL }}
          echo "Added new conan remote '${{ env.CONAN_REMOTE_NAME }}' at ${{ env.CONAN_REMOTE_URL }}."
      - name: Export the recipes
        working-directory: recipes
        run: |
          # Loop over all recipes to export.
          IFS=' ' read -ra EXPORTS <<< '${{ env.CONAN_EXPORTS }}'
          for EXPORT in "${EXPORTS[@]}"; do
            conan export "${EXPORT}" --remote ${{ env.CONAN_REMOTE_NAME }}
          done
